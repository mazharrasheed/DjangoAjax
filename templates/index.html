{% load crispy_forms_tags %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"/>
  </head>
  <body>
    <div class= "container"> 
        <div class="row">
            <div class="col-5 border rounded p-4 m-4 ">
                <form action="#" id="officeform">
                    {%csrf_token%}
                    <!-- one of two methods to pevernt form submision -->
                    <h1 style="margin-left: 5%">Office</h1>
                    {{officeform|crispy}}
                    <input class ='btn btn-info' type="submit" value="Save Office" />
                </form>
            </div>
            <div class="col-6">
                <table class="table" id="officetable">
                    <thead>
                        <tr>
                            <td>Sr.No.</td>
                            <td>Name</td>
                            <td>Location</td>
                        </tr>
                    </thead>
                    <tbody id="officetbl">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-5 border rounded p-4 m-4">
                <form action="#" id="employeeform">
                    <!-- tow of two methods to pevernt form submision -->
                   
                    {%csrf_token%}
                    <h1 style="margin-left: 5%">Employee</h1>
                    {{employeeform|crispy}}
                    <input class ='btn btn-info' type="submit" value="Save Employee" />
                </form>
            </div>
            <div class="col-6">
                <table class="table" id="emptable">
                    <thead>
                        <tr>
                            <td>Sr.No.</td>
                            <td>First Name</td>
                            <td>Last Name</td>
                            <td>E-mail</td>
                            <td>Gender</td>
                            <td>Office</td>
                        </tr>
                    </thead>
                    <tbody id="emptbl">
                    </tbody>
                </table>
            </div>
        </div>         
    </div>
</body>
</html>

<script>
    officeslist=[]
    emplist=[]
  $(document).ready(function () {

    getalloffices()
    getallemployees()
  });

  function getalloffices(){
    $.ajax({
        method: "GET",
        url: "/offices/",
      })
      .done(response=>{
        const tempoffices=JSON.parse(response)
        officeslist=tempoffices
        officeslist=officeslist.map(e=>e.fields)
        renderofficetable()
      });
  }
  function renderofficetable(){
    let tableBody=document.getElementById('officetbl');
    tableBody.remove();
    let newBody=document.createElement('tbody');
    newBody.id='officetbl';
    document.getElementById('officetable').append(newBody);
    officeslist.forEach(
        function (office,index){
            const row=newBody.insertRow();
            const count=document.createElement('TD');
            count.innerHTML=index + 1;
            const name=document.createElement('TD');
            name.innerHTML=office.name;
            const location=document.createElement('TD');
            location.innerHTML=office.locations;
            row.appendChild(count);
            row.appendChild(name);
            row.appendChild(location);   
        }
    )

  }
  // get all employees
  function getallemployees(){
    $.ajax({
        method: "GET",
        url: "/employees/",
      })
      .done(response=>{
        const tempemp=JSON.parse(response)
        emplist=tempemp
        emplist=emplist.map(e=>e.fields)
        renderemptable()
      });
  }
  function renderemptable(){
    let tableBody=document.getElementById('emptbl');
    tableBody.remove();
    let newBody=document.createElement('tbody');
    newBody.id='emptbl';
    document.getElementById('emptable').append(newBody);
    emplist.forEach(
        function (emp,index){
            const row=newBody.insertRow();
            const count=document.createElement('TD');
            count.innerHTML=index + 1;
            const fname=document.createElement('TD');
            fname.innerHTML=emp.firstname;
            const lname=document.createElement('TD');
            lname.innerHTML=emp.lastname;
            const email=document.createElement('TD');
            email.innerHTML=emp.email;
            const gender=document.createElement('TD');
            gender.innerHTML=emp.gender;
            const office=document.createElement('TD');
            office.innerHTML=emp.office;
            row.appendChild(count);
            row.appendChild(fname);
            row.appendChild(lname);
            row.appendChild(email);
            row.appendChild(gender);
            row.appendChild(office);
        }
    )

  }

  function officeformsubmit(event) {
    //  one of two methods to pevernt form submision
    event.preventDefault();
    const valuesinarry = $(this).serializeArray();
    const body = {};
    //valuesinarry.forEach(e=>{
    //body[e.name]=e.value
    //})
    valuesinarry.reduce((body, e) => {
      body[e.name] = e.value;
      return body;
    }, body);

    $.ajax({
      method: "POST",
      url: "/office/",
      data: body,
    })
      .done(function (response) {
        console.log(response);
        event.target.reset();
        officeslist.push(response)
        renderofficetable()
        
      })
      .fail(function (response) {
        console.log(response);
      });
  }

  function employeeformsubmit(event) {
    //  one of two methods to pevernt form submision
    event.preventDefault();
    const valuesinarry = $(this).serializeArray();
    const body = {};
    valuesinarry.forEach((e) => {
      body[e.name] = e.value;
    });
    //valuesinarry.reduce((body, e) => {
    //body[e.name] = e.value;
    //return body;
    //}, body);
    $.ajax({
      method: "POST",
      url: "/employee/",
      data: body,
    })
      .done(function (response) {
        console.log(response);
        event.target.reset();
        emplist.push(response)
        renderemptable()
      })
      .fail(function (response) {
        console.log(response);
      });
  }
  $("#officeform").submit(officeformsubmit);
  $("#employeeform").submit(employeeformsubmit);
</script>
